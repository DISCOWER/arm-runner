name: Trigger
on:
  workflow_dispatch:
    inputs:
      dockerfile:
        description: "Path to the Dockerfile"
        required: false
        default: "dockerfiles/px4_mpc.Dockerfile"
      image_name:
        description: "Image name (without registry/repo)"
        required: false
        default: "px4_mpc"
  push:
    branches: [ main ]
    paths:
      - 'dockerfiles/**'
      - 'docker-compose.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      REGISTRY: kth-registry.waraps.org   # your Zot host (no /zot here)
      REPO_BASE: dev                      # pushes under dev/** as per ACL
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # Decide Dockerfile and image name: prefer workflow_dispatch inputs, otherwise fall back
      - name: Resolve inputs
        id: resolve
        run: |
          DOCKERFILE="${{ github.event.inputs.dockerfile }}"
          IMAGE_NAME="${{ github.event.inputs.image_name }}"

          # fallback if triggered by push or inputs empty
          if [ -z "$DOCKERFILE" ]; then
            DOCKERFILE="dockerfiles/px4_mpc.Dockerfile"
          fi
          if [ -z "$IMAGE_NAME" ]; then
            IMAGE_NAME="px4_mpc"
          fi

          echo "DOCKERFILE=$DOCKERFILE" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      # Normalize image repo name: lowercase + no underscores
      - name: Sanitize image repo name
        id: sanitize
        run: |
          SAFE_IMAGE_NAME="$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g' | sed 's/_/-/g')"
          echo "SAFE_IMAGE_NAME=$SAFE_IMAGE_NAME" >> "$GITHUB_ENV"
          echo "IMAGE=${{ env.REGISTRY }}/${{ env.REPO_BASE }}/${SAFE_IMAGE_NAME}" >> "$GITHUB_ENV"
          echo "TAG_SHA=${{ github.sha }}" >> "$GITHUB_ENV"
          echo "Using IMAGE=${{ env.REGISTRY }}/${{ env.REPO_BASE }}/${SAFE_IMAGE_NAME}"

      - name: Log in to Zot
        env:
          ZOT_USERNAME: ${{ secrets.ZOT_USERNAME }}
          ZOT_PASSWORD: ${{ secrets.ZOT_PASSWORD }}
        run: |
          echo "$ZOT_PASSWORD" | docker login ${{ env.REGISTRY }} -u "$ZOT_USERNAME" --password-stdin

      - name: Build & push (OCI, single-arch, no provenance/SBOM)
        run: |
          set -euo pipefail
          echo "Building Dockerfile: $DOCKERFILE"
          echo "Tagging as:"
          echo " - $IMAGE:$TAG_SHA"
          echo " - $IMAGE:latest"

          docker buildx build \
            --platform linux/arm64 \
            --provenance=false \
            --sbom=false \
            --output "type=registry,oci-mediatypes=true,name=$IMAGE:$TAG_SHA,name=$IMAGE:latest,push=true" \
            -f "$DOCKERFILE" \
            .

      - name: Logout
        if: always()
        run: docker logout ${{ env.REGISTRY }} || true

      - name: Summary
        if: success()
        run: |
          echo "âœ… Pushed:"
          echo "  - $IMAGE:$TAG_SHA"
          echo "  - $IMAGE:latest"
