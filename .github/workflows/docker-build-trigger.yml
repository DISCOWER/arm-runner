name: Trigger

on:
  workflow_dispatch:
    inputs:
      dockerfile_name:
        description: "Filename to write on the runner"
        required: false
        default: "Dockerfile"
      image_name:
        description: "Image name (without registry/repo)"
        required: false
        default: "px4_mpc"
      dockerfile_content_b64:
        description: "Base64-encoded Dockerfile content"
        required: true
  push:
    branches: [ main ]
    paths:
      - 'dockerfiles/**'
      - 'docker-compose.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      REGISTRY: kth-registry.waraps.org
      REPO_BASE: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve inputs & write Dockerfile
        run: |
          DOCKERFILE_NAME="${{ github.event.inputs.dockerfile_name }}"
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          CONTENT_B64="${{ github.event.inputs.dockerfile_content_b64 }}"

          if [ -z "$DOCKERFILE_NAME" ]; then
            DOCKERFILE_NAME="Dockerfile"
          fi
          if [ -z "$IMAGE_NAME" ]; then
            IMAGE_NAME="px4_mpc"
          fi

          echo "$CONTENT_B64" | base64 -d > "$DOCKERFILE_NAME"

          echo "DOCKERFILE_NAME=$DOCKERFILE_NAME" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Sanitize image repo name
        run: |
          SAFE_IMAGE_NAME="$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g' | sed 's/_/-/g')"
          echo "SAFE_IMAGE_NAME=$SAFE_IMAGE_NAME" >> "$GITHUB_ENV"
          echo "IMAGE=${{ env.REGISTRY }}/${{ env.REPO_BASE }}/${SAFE_IMAGE_NAME}" >> "$GITHUB_ENV"
          echo "TAG_SHA=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Log in to Zot
        env:
          ZOT_USERNAME: ${{ secrets.ZOT_USERNAME }}
          ZOT_PASSWORD: ${{ secrets.ZOT_PASSWORD }}
        run: |
          echo "$ZOT_PASSWORD" | docker login ${{ env.REGISTRY }} -u "$ZOT_USERNAME" --password-stdin

      - name: Build & push
        run: |
          set -euo pipefail
          echo "Building Dockerfile: $DOCKERFILE_NAME"
          docker buildx build \
            --platform linux/arm64 \
            --provenance=false \
            --sbom=false \
            --output "type=registry,oci-mediatypes=true,name=$IMAGE:$TAG_SHA,name=$IMAGE:latest,push=true" \
            -f "$DOCKERFILE_NAME" \
            .
